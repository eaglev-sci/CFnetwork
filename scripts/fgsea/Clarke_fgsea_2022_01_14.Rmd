---
title: "CF_fgsea"
output: pdf_document
---

```{r}
library(fgsea)
library(data.table)
library(ggplot2)
library(tidyverse)
library(GEOquery)
```

```{r}
GPL10097 <- getGEO("GPL10097")
GPL10097_map_table <- GPL10097@dataTable@table[,c("ID", "Gene Name")]
colnames(GPL10097_map_table) <- c("ID", "Symbol")
```

```{r}
Clarke_ges <- getGEO("GSE40445",GSEMatrix=TRUE)
Clarke_RNA_data <- data.frame(exprs(Clarke_ges[[1]]))
Clarke_RNA_data$gene_id <- rownames(Clarke_RNA_data)

# res_df <- read.table("~/ownCloud/Thèse/Systems Biology/Transcriptomic studies/Transcriptomic Analyses/Analyse Clarke/DE_Analysis/Clarke_differential_expression_analysis_limma_2022_01_24.txt",
#                          sep = "\t",
#                          header = T)
# 
# res_df$Gene_id <- rownames(res_df)
# 
# res_df <- merge(res_df,
#                 GPL10097_map_table,
#                                  by.x = "Gene_id",
#                                  by.y = "ID",
#                                  all.x = TRUE)
# 
# res_df <- res_df[which(!is.na(res_df$Symbol)),]
# res_df <- res_df[which(res_df$Symbol!=""),]
# 
# HGNC_occ <- data.frame(table(res_df$Symbol))
# unique_genes <- HGNC_occ[which(HGNC_occ$Freq==1), "Var1"]
# 
# res_df_HGNC_unique <- res_df[which(res_df$Symbol %in% unique_genes),]
# 
# duplicated_genes <- unique(res_df[duplicated(res_df$Symbol), "Symbol"])
# 
# affy_id_to_keep <- sapply(duplicated_genes, function(gene){
#   affy_id <- res_df[which(res_df$Symbol==gene),"Gene_id"]
#   
#   data_gene <- Clarke_RNA_data[affy_id,]
#   data_gene$mean <- rowMeans(data_gene, na.rm = TRUE)
#   data_gene$sd <- apply(data_gene,1, sd, na.rm = TRUE)
#   data_gene$threshold <- data_gene$mean/data_gene$sd
#   
#   affy_id_to_keep <- rownames(data_gene[which.max(data_gene$threshold),])
#   return(affy_id_to_keep)
# })
# res_df_HGNC_to_keep <- res_df[which(res_df$Gene_id %in% affy_id_to_keep),]
# 
# res_df_HGNC_final <- rbind(res_df_HGNC_unique,
#                           res_df_HGNC_to_keep)

# write.table(res_df_HGNC_final,
#             file = "~/ownCloud/Thèse/Systems Biology/Transcriptomic studies/Analyse Clarke/DE_Analysis/Clarke_DEG_limma_unique_HGNC_2022_01_24.csv",
#             sep = "\t",
#             row.names = F)

res_df_HGNC_final <- read.table("~/ownCloud/Thèse/Systems Biology/Transcriptomic studies/Transcriptomic Analyses/Analyse Clarke/DE_Analysis/Clarke_DEG_limma_unique_HGNC_2022_01_24.csv",
                         sep = "\t",
                         header = T)

Clarke_stat <- res_df_HGNC_final[,c("Symbol", "t")]

ranks <- deframe(Clarke_stat)
```


```{r}
# pathways.hallmark <- gmtPathways("~/ownCloud/Thèse/Systems Biology/gmt/h.all.v7.4.symbols.gmt")
# all_pathways <- gmtPathways("~/ownCloud/Thèse/Systems Biology/gmt/all_pathways_2022_01_12.gmt")
# all_pathways <- gmtPathways("~/ownCloud/Thèse/Systems Biology/gmt/wikipathways_filtered_gsea_2022_09_07.gmt")
all_pathways <- gmtPathways("~/ownCloud/Thèse/Systems Biology/gmt/kegg_from_omnipathR_gsea_2022_09_07.gmt")
kegg_pathways <- lapply(X = all_pathways, FUN = function(gene_list){
  return(gene_list[lapply(gene_list, nchar)>0])
})
```

```{r}
fgseaRes <- fgsea(pathways = dorothea_pathways, 
                  stats    = ranks,
                  minSize  = 0,
                  maxSize  = 500,
                  #nperm=10000,
                  eps=0.0)

save(fgseaRes,
     file = "~/ownCloud/Thèse/Systems Biology/Transcriptomic studies/Transcriptomic Analyses/Analyse Clarke/GSEA/Clarke_fgsea_report_dorothea_pathways_2022_09_07.RData")
# write.table(data.frame(fgseaRes[,-c("leadingEdge")]),
#             file = "~/ownCloud/Thèse/Systems Biology/Transcriptomic studies/Analyse Clarke/GSEA/Clarke_fgsea_report_2021_01_14.tsv",
#             sep = "\t")
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}
library(ggplot2)

density <- ggplot(fgseaRes, aes(x=pval))+
  geom_density()
```